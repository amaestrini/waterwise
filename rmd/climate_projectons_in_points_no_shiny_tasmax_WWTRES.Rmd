---
title: "Climate Projections in Point"
author: "Emanuele Cordano"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: inline
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RMAWGEN)
library(magrittr)
library(sf)
library(cordexr)
library(dplyr)
library(ggplot2)
library(rbokeh)
library(zoo)
library(quantreg)
```


***
## Trentino Dataset (RMAWGEN)

Trentino daily climate dataset from *RMAWGEN* (https://CRAN.R-project.org/package=RMAWGEN) :


```{r trentino,eval=TRUE,echo=FALSE,output=FALSE,results="hide",message=FALSE}

data(trentino)
stations <- cbind(as.data.frame(STATION_LATLON),STATION_NAMES) %>% st_as_sf(coords=c(1,2),crs=4326)
stations$source <- "RMAWGEN"
##mapview::mapview(stations)
#rlatlon <- cordex_grid_vertices(ncs[1],crop_sf=stations)

##
trentino_pr <- PRECIPITATION %>% melt(id=c("month","day","year"))
names(trentino_pr)[names(trentino_pr)=="variable"] <- "STATION_NAMES"
trentino_pr$variable <- "pr" ## EURO-CORDEX name
##
##
trentino_tasmin <- TEMPERATURE_MIN %>% melt(id=c("month","day","year"))
names(trentino_tasmin)[names(trentino_tasmin)=="variable"] <- "STATION_NAMES"
trentino_tasmin$variable <- "tasmin" ## EURO-CORDEX name
##
trentino_tasmax <- TEMPERATURE_MAX %>% melt(id=c("month","day","year"))
names(trentino_tasmax)[names(trentino_tasmax)=="variable"] <- "STATION_NAMES"
trentino_tasmax$variable <- "tasmax" ## EURO-CORDEX name
##
trentino <- rbind(trentino_pr,trentino_tasmin,trentino_tasmax)
trentino_monthly <- trentino %>% group_by(month,year,STATION_NAMES,variable) %>% summarise(value=mean(value,na.rm=TRUE)) %>% ungroup()


```

## Integration with WasteWise Station  (RMAWGEN)

Addition of time series provided by WaterWise project:




```{r WaterWise,echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE,print=FALSE,results="hold"}

library(readxl)


## global path:
dati_meteo_2022_1_file  <- "/home/ecor/activity/2022/fbk/local/waterwise/data/dati_meteo_2022_1.xlsx"
## local path: 
##dati_meteo_2022_1_file  <- ".../data/dati_meteo_2022_1.xlsx"
sheets <- c("Segno (per Tres)", "Rovere Luna")
names(sheets) <- c("WWTRES","WWRLUN")
###
stations_waterwise <- stations[1:length(sheets),]
stations_waterwise$source <- "WaterWise"
stations_waterwise$STATION_NAMES <- names(sheets)
####
stations <- rbind(stations,stations_waterwise)
# Rovere 2 siti:
# 46.252253, 11.177731
# 46.252713, 11.172209
# Tres 1 sito:
# 46.312991, 11.088398
## https://www.meteotrentino.it/#!/content?menuItemDesktop=143 Tres T0088 46.3207	11.1014
# Rovere
# 46.252253, 11.17773
# 
# Tres:
# 46.312991, 11.088398
# 
# mi confermi anche che ti e' arrivato invito per Github?

# Grazie e ciao
# Andrea
stations_waterwise$geometry[1] <- c(11.088398,46.312991) %>% st_point()
stations_waterwise$geometry[2] <- c(11.177731,46.252253) %>% st_point()
# ###
waterwise <- list()
for (it in names(sheets)) {
  waterwise[[it]] <- read_excel(dati_meteo_2022_1_file,sheet = sheets[it])
  names(waterwise[[it]]) <- c("Date","day","month","year","tas","tasmax","tasmin","pr")
  waterwise[[it]]$STATION_NAMES <- it
}
waterwise <-  do.call(waterwise,what="rbind") %>% select(-Date) %>% melt(id=c("day","month","year","STATION_NAMES"))
####
####
####
####
trentino <- rbind(trentino,waterwise[,names(trentino)])
trentino_monthly <- trentino %>% group_by(month,year,STATION_NAMES,variable) %>% summarise(value=mean(value,na.rm=TRUE)) %>% ungroup()

stations <- rbind(stations,stations_waterwise)

col.regions <- stations$source
col.regions[] <- "black"
col.regions[stations$source=="WaterWise"] <- "blue"

mapview::mapview(stations,col.regions=col.regions)

```


## Available Projections (from CORDEX)

Example of station locations within the grid provided by CORDEX outcome files (https://cds.climate.copernicus.eu/cdsapp#!/dataset/projections-cordex-domains-single-levels?tab=overview). 

```{r grid_example_code,echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE,print=FALSE,results="hide"}

library(cordexr)


ncs <- '/home/ecor/local/data/climate/cordex/europe/monthly_2051_2100_unzipped/'  %>% list.files(full.name=TRUE,pattern=".nc")
nc <- ncs[1]
rlatlon <- cordex_grid_vertices(nc,crop_sf=stations)


## LOOK AT ST_WITHIN
station_cell <- st_within(stations,rlatlon,sparse=TRUE) %>% sapply(function(x){x[1]}) ## see buffer
stations$nccell <- station_cell

out2 <- as.data.frame(rlatlon[station_cell,]) %>% select(-geometry) %>% cbind(stations)

###


##station_cell <- st_within(stations,rlatlot) %>% unlist()## see buffer

```
```{r grid_example_plot,echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE,print=FALSE,results="hold"}
plot(st_geometry(rlatlon))
plot(stations,add=TRUE)
```

<!-- Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot. -->
### List of RCM and GCM models

Here is a list of available combinations of GCMs and RCMS: 
```{r rcm,echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE,print=FALSE,results="hide"}


sims <- cordex_netcdf_attributes_multi_sources(ncs)

knitr::kable(sims %>% select(driving_model_id,model_id,experiment_id,variable,source))
```


```{r values,echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE,print=FALSE,results="hide"}
cc <- system.time({
##source("~/local/rpackages/rendena100/cordexr/R/which_ncvar_name.R")
##source("~/local/rpackages/rendena100/cordexr/R/cordex_grid_cell_values.R")
##source("~/local/rpackages/rendena100/cordexr/R/codex_grid_vertices.R")
##source("~/local/rpackages/rendena100/cordexr/R/cordex_grid_cell_value_from_points.R")
####
it_station <- c("WWTRES","WWRLUN","T0099","T0083","T0236","SMICH","T0090","T0169")
## Global path: 
out44_file <- '/home/ecor/activity/2022/fbk/local/data/climate_historical_rcp_%s.rds' %>% 
sprintf(paste(it_station,collapse="_"))
## local (other) path: 
out44_file <- '/home/ecor/activity/2022/fbk/local/waterwise/data/climate_historical_rcp_%s.rds' %>% 
sprintf(paste(it_station,collapse="_"))

force <- !file.exists(out44_file)
sf_use_s2(FALSE)
stations0 <- stations %>% filter(STATION_NAMES %in% it_station)
if (force==TRUE) {
 ### 

  out44 <- NULL

###
  models <- paste(sims$driving_model_id,sims$model_id,sep="_") 
  issued_models <- c("ICHEC-EC-EARTH_CLMcom-ETH-COSMO-crCLIM-v1-1","ICHEC-EC-EARTH_DMI-HIRHAM5","ICHEC-EC-EARTH_KNMI-RACMO22E","ICHEC-EC-EARTH_SMHI-RCA4","MOHC-HadGEM2-ES_CLMcom-ETH-COSMO-crCLIM-v1-1",
                   "MOHC-HadGEM2-ES_CNRM-ALADIN63","MOHC-HadGEM2-ES_DMI-HIRHAM5","MOHC-HadGEM2-ES_ICTP-RegCM4-6","MOHC-HadGEM2-ES_KNMI-RACMO22E",
                    "MOHC-HadGEM2-ES_MOHC-HadREM3-GA7-05","MOHC-HadGEM2-ES_SMHI-RCA4","MPI-M-MPI-ESM-LR_CLMcom-ETH-COSMO-crCLIM-v1-1","MPI-M-MPI-ESM-LR_CNRM-ALADIN63","MPI-M-MPI-ESM-LR_DMI-HIRHAM5",
                   "MPI-M-MPI-ESM-LR_ICTP-RegCM4-6","MPI-M-MPI-ESM-LR_KNMI-RACMO22E","MPI-M-MPI-ESM-LR_SMHI-RCA4","MIROC-MIROC5_UHOH-WRF361H") 
  issued_models2 <- c("MOHC-HadGEM2-ES_CNRM-ALADIN63","MOHC-HadGEM2-ES_DMI-HIRHAM5","MOHC-HadGEM2-ES_ICTP-RegCM4-6","MOHC-HadGEM2-ES_KNMI-RACMO22E",
                    "MOHC-HadGEM2-ES_MOHC-HadREM3-GA7-05","MOHC-HadGEM2-ES_SMHI-RCA4","MPI-M-MPI-ESM-LR_CLMcom-ETH-COSMO-crCLIM-v1-1","MPI-M-MPI-ESM-LR_CNRM-ALADIN63","MPI-M-MPI-ESM-LR_DMI-HIRHAM5",
                   "MPI-M-MPI-ESM-LR_ICTP-RegCM4-6","MPI-M-MPI-ESM-LR_KNMI-RACMO22E","MPI-M-MPI-ESM-LR_SMHI-RCA4","MIROC-MIROC5_UHOH-WRF361H") 
  issued_models3 <- "MIROC-MIROC5_UHOH-WRF361H"
## "MIROC-MIROC5_UHOH-WRF361H" contains height dimension for tas,tasmin and tasmax!!!

  for (i in (1:nrow(sims))[!(models %in% issued_models3)])   {
    nc <- sims$file[i]
    it <- paste(sims$driving_model_id[i],sims$model_id[i],sep="_") 
    temp <- cordex_grid_cell_value_from_points(nc,crop_sf=stations0)
    ####
    ####
    temp$variable <- sims$variable[i]
    names(temp)[names(temp)==sims$variable[i]] <- "value"
    temp$model <- it
    temp$experiment <- sims$experiment_id[i]
    names(temp)[names(temp)=="STATION_NAMES"] <- "station"
    ####
    if (sims$variable[i]=="pr") {
   
      temp$value[temp$value<0] <- NA
  ## units from kg m-2 s-1 to mm/day
      temp$value <-   temp$value/1000*1000*3600*24 ##*as.numeric(nnday)
      temp$value[temp$value>=1000/30] <- NA
    } else if (sims$variable[i] %in% c("tasmin","tasmax","tas")) {
      
      temp$value <-   temp$value-273.15
    }
    ####
    temp <- temp %>% select(time,value,variable,station,model,experiment) %>% as_tibble()
    out44 <- temp %>% rbind(out44)
  }
  
  saveRDS(out44,file=out44_file)
} else {
  out44 <- readRDS(out44_file)
}

})




```
```{r add_trentino,echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE,print=FALSE,results="hide"}
out50 <- out44 ## out40 %>% do.call(what="rbind")
#### TEMPORARY 
ic <- which(out50$variable %in% c("tasmin","tasmax","tas"))
###if (length(ic)>0) out50$value[ic] <-   out50$value[ic]-273.15
out50$gcm <- str_split(out50$model,"_") %>% sapply(function(x){x[1]})
out50$rcm <- str_split(out50$model,"_") %>% sapply(function(x){x[2]})



####
trentino_monthly$model <- "observation"
trentino_monthly$experiment <- "observation"
trentino_monthly$rcm <- "observation"
trentino_monthly$gcm <- "observation"

names(trentino_monthly)[names(trentino_monthly)=="STATION_NAMES"] <- "station"
trentino_monthly$time <- sprintf("%04d-%02d-01",trentino_monthly$year,trentino_monthly$month) %>% as.Date()
out50$time <- sprintf("%04d-%02d-01",year(out50$time),month(out50$time)) %>% as.Date()
####
trentino_monthly2 <- trentino_monthly[,names(out50)] %>% filter(station %in% unique(out50$station))
out50 <- out50 %>% rbind(trentino_monthly2)


```

***
## Time Series 1951-2005 (historical) ; 2006-2100 (RCP85)  


```{r zoo001,echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE,print=FALSE,results="hold"}
library(zoo)
library(dygraphs)
library(stringr)

selected_global_model <- "MPI-M-MPI-ESM-LR"
station0 <- "WWRLUN"
## INPUT PANEL SELECTION


##outf <- reactiveValues()

rzoo_code <- function(
  data_in=out50,
  station0="WWRLUN",
  in_selected_global_model="MPI-M-MPI-ESM-LR",
  varsel="temp"
)  {

  outf <- list()


  variables <- c("tasmin","tasmax","pr")


  out70 <- data_in %>% filter(experiment %in% c("historical","rcp85","observation"),gcm %in% c(in_selected_global_model,"observation"))  %>% dplyr::filter(station==station0)

##%>% filter(model %in% n_models)
  ttttz <- out70 %>% filter(variable %in% variables,!is.na(time)) %>% select(value,variable,model,time)


  tasminz <- ttttz %>% filter(variable=="tasmin") %>% select(-variable) %>% dcast(time  ~ model,fun.aggregate=mean)
  time <- tasminz$time
  tasminz <- tasminz %>% select(-time) %>% as.zoo()
  index(tasminz) <- time
  ###

  tasmaxz <- ttttz %>% filter(variable=="tasmax") %>% select(-variable) %>% dcast(time  ~ model,fun.aggregate=mean)
  time <- tasmaxz$time
  tasmaxz <- tasmaxz %>% select(-time) %>% as.zoo()
  index(tasmaxz) <- time
  ####

  prz <- ttttz %>% filter(variable=="pr") %>% select(-variable) %>% dcast(time  ~ model,fun.aggregate=mean)
  time <- prz$time
  prz <- prz %>% select(-time) %>% as.zoo()
  index(prz) <- time

  ## ZOO OBJECTS
  if (varsel=="temp") {
    tempz <- (tasminz+tasmaxz)/2
    outf$main <- "Monthly averaged (max+min)/2 temperature vs time (%s) at %s" %>% sprintf(in_selected_global_model,station0)
    outf$ylab <- "Temperature [deg C]"
    outf$stepPlot <- FALSE
    outf$zoov <- tempz
    #dygraph(zoov,main=main,xlab="Time",ylab=ylab) %>% dyRangeSelector() %>% dySeries("observation", stepPlot = stepPlot, color = "blue")

  }

  if (varsel=="tasmin") {
    outf$main <- "Monthly averaged Daily Minium temperature vs time (%s) at %s" %>% sprintf(in_selected_global_model,station0)
    outf$ylab <- "Temperature [deg C]"
    outf$stepPlot <- FALSE
    outf$zoov <- tasminz
    #dygraph(zoov,main=main,xlab="Time",ylab=ylab) %>% dyRangeSelector() %>% dySeries("observation", stepPlot = stepPlot, color = "blue")

  }

  if (varsel=="tasmax") {
    outf$main <- "Monthly averaged Daily Maximum temperature vs time (%s) at %s" %>% sprintf(in_selected_global_model,station0)
    outf$ylab <- "Temperature [deg C]"
    outf$stepPlot <- FALSE
    outf$zoov <- tasmaxz
    #dygraph(zoov,main=main,xlab="Time",ylab=ylab) %>% dyRangeSelector() %>% dySeries("observation", stepPlot = stepPlot, color = "blue")

  }

  if (varsel=="diff_temp") {
    difftempz <- (tasmaxz-tasminz)
    outf$main <- "Monthly averaged diurnal thermal range vs time (%s) at %s" %>% sprintf(in_selected_global_model,station0)
    outf$ylab <- "Temperature diff. [deg C]"
    outf$stepPlot <- FALSE
    outf$zoov <- difftempz
    #dygraph(zoov,main=main,xlab="Time",ylab=ylab) %>% dyRangeSelector() %>% dySeries("observation", stepPlot = stepPlot, color = "blue")

  }

  if (varsel=="pr") {
    outf$main <- "Monthly averaged daily precipitation vs time (%s) at %s" %>% sprintf(in_selected_global_model,station0)
    outf$ylab <- "Daily precipitation [mm/day]"
    outf$zoov <- prz
    outf$stepPlot <- TRUE
    # dygraph(zoov,main=main,xlab="Time",ylab=ylab) %>% dyRangeSelector() %>% dySeries("observation", stepPlot = stepPlot,color = "blue")
  }

  #### for bokeh module
  outf$ttt0 <- as.data.frame(outf$zoov)
  outf$ttt0$month <- month(as.Date(index(outf$zoov)))
  outf$ttt0$year <- year(as.Date(index(outf$zoov)))
  outf$ttt0$time <- as.Date(index(outf$zoov))
  outf$ttt0 <- melt(outf$ttt0,id=rev(c("year","month","time","observation"))) 
  names(outf$ttt0)[names(outf$ttt0)=="variable"] <- "model"
  outf$ttt <- outf$ttt0 %>% filter(!is.na(observation))
  
  
  #### MODEL
  ##outf$dowscaling_model <- glm(observation ~ value+model+factor(month),data=outf$ttt)
  ##outf$dowscaling_model <- glm(observation ~ value+model,data=outf$ttt)
  outf$dowscaling_model <- rq(observation ~ value+model,data=outf$ttt)
  ####
  outf$ttt0$predicted <- predict(outf$dowscaling_model,newdata=outf$ttt0)
  
  ####
  outf$zoov_modeled <- outf$ttt0 %>% select(model,time,predicted) %>% dcast(time  ~ model,fun.aggregate=mean)
  time <- outf$zoov_modeled$time
  outf$zoov_modeled  <- outf$zoov_modeled %>% select(-time) %>% as.zoo()
  index(outf$zoov_modeled) <- time
  outf$zoov_modeled$observation <- outf$zoov$observation

  return(outf)
}


##outf <<- rzoo_code()

##})


rr <<- rzoo_code()
```




```{r zoo002,echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE,print=FALSE,results="hold"}


#global_models_u=unique(out50$gcm)
##f (shiny) {
#inputPanel(
#  selectInput(inputId = "gcm", label = "Global Climate Model", choices =   #global_models_u,selected=formals(rzoo_code)$in_selected_global_model),
#  selectInput(inputId = "station", label = "Station (site)", choices = #unique(out50$station),selected=formals(rzoo_code)$station0),
#  selectInput(inputId = "varsel", label = "Variable", choices = #c("tasmin","tasmax","temp","diff_temp","pr"),selected=formals(rzoo_code)$varsel)
 
  input <- list()
  input$gcm <- formals(rzoo_code)$in_selected_global_model
  input$station <- c("WWRLUN","WWTRES")[2] ##formals(rzoo_code)$station0)
  input$varsel <- c("tasmin","tasmax","temp","diff_temp","pr")[2]
   
###)

```

Lorem Ipsum

```{r zoo003a,echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE,print=TRUE,results="hold"}

#rrev <- reactiveVal()

##renderDygraph({
  rr <- rzoo_code(
  data_in=out50,
  station0=input$station,
in_selected_global_model=input$gcm,
varsel=input$varsel
) 
###rrev(rr)
dygraph(rr$zoov,main=rr$main,xlab="Time",ylab=rr$ylab) %>% dyRangeSelector() %>% dyOptions(stepPlot=rr$stepPlot) %>% dySeries("observation", stepPlot = rr$stepPlot,color = "blue") #%>% dyLegend(width=100)
##})
# 
# ### https://hafen.github.io/rbokeh/articles/rbokeh.html


##input0 <- reactiveValues(input=input)
##isolate(input0)

```


Lorem Ipsum: 

```{r zoo003,echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE,print=TRUE,results="hold",fig.width=100}

##renderRbokeh({

 rr <- rzoo_code(
  data_in=out50,
  station0=input$station,
in_selected_global_model=input$gcm,
varsel=input$varsel
)  
  
#message("data")
#isolate(rr <- rrev())
#head(rr$ttt)
figure(title=rr$main2,ylab=rr$ylab,data=rr$ttt,width=1000) %>% ly_points(observation,value,color = month, glyph = model,hover = list(observation, value,model,month,year),legend=FALSE)
##})
```

DOWNSCALED: 

```{r zoo004,echo=FALSE,eval=TRUE,message=FALSE,warning=FALSE,print=TRUE,results="hold"}

##rrev <- reactiveVal()

#renderDygraph({
  rr <- rzoo_code(
  data_in=out50,
  station0=input$station,
in_selected_global_model=input$gcm,
varsel=input$varsel
) 
##rrev(rr)
dygraph(rr$zoov_modeled,main=rr$main,xlab="Time",ylab=rr$ylab) %>% dyRangeSelector() %>% dyOptions(stepPlot=rr$stepPlot) %>% dySeries("observation", stepPlot = rr$stepPlot,color = "blue") 
##})
# 
# ### https://hafen.github.io/rbokeh/articles/rbokeh.html


##input0 <- reactiveValues(input=input)
##isolate(input0)

```



## References 

TO DO
```{r generateBibliography,echo=FALSE,eval=FALSE,message=FALSE,warning=FALSE,print=FALSE,results="hide"}

require(knitcitations)
cleanbib()
options(citation_format="pandoc")
read.bibtex(file = "bibliography.bib")


```



